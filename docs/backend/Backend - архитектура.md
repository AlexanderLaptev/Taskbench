# Бэкенд Taskbench

## Общая архитектура
- Python 3.12+
- Django 5.2
- PostgreSQL 17
- Трёхслойная архитектура:
  - API (views) - обработка HTTP-запросов
  - Services - бизнес-логика
  - Models - работа с данными и БД

## Основные компоненты

### Ядро приложения
- `backend/` - основные настройки Django
  - `settings.py` - конфигурация приложения (переменные окружения, БД, JWT)
  - `urls.py` - корневые URL
  - `asgi.py` - точка входа для ASGI-серверов (асинхронные приложения)
  - `wsgi.py` - точка входа для WSGI-серверов (традиционные приложения)

### Модули приложения
1. **Taskbench** (основной модуль)
   - `models/` - модели данных (User, Task, Subtask, Category, TaskCategory, Subscription)
   - `services/` - бизнес-логика (работа с задачами, пользователями и т.д.)
   - `views/` - обработчики API
   - `serializers/` - сериализаторы для API
   - `tests/` - модульные тесты
   - `scheduler.py` - планировщик автозадач

2. **Subscription** (подписки)
   - Работа с платежами через YooKassa
   - Автоматическое продление подписок
   - Webhook-обработчик платежей

3. **Suggestion** (AI-рекомендации)
   - Интеграция с GigaChat API
   - Генерация подзадач, категорий, сроков

4. **Dashboard** (админ-панель)
   - Кастомные страницы статистики
   - Управление подписками
   - Шаблоны: `dashboard.html`, `subscriptions.html`, `login.html`

## Технологический стек

### Основные фреймворки и библиотеки
1. Django - основной веб-фреймворк
2. Django REST Framework - REST API
3. SimpleJWT - JWT-аутентификация
4. APScheduler - планировщик задач (для подписок)
5. GigaChat - AI для рекомендаций
6. YooKassa - платежная система
7. PostgreSQL - основная БД
8. Locust - нагрузочное тестирование

### Вспомогательные инструменты
1. Docker - контейнеризация
2. Nginx - прокси и статика
3. Pydantic - валидация данных
4. psycopg2 - драйвер PostgreSQL
5. python-dotenv - управление переменными окружения

## Жизненный цикл запроса

1. **Запрос поступает** в один из обработчиков views через URL-роутинг
2. **Аутентификация** через JWT для защищённых эндпоинтов
3. **Валидация** входных данных через сериализаторы
4. **Обработка** бизнес-логики в services
5. **Взаимодействие** с моделями и БД
6. **Формирование** ответа через сериализаторы
7. **Возврат** JSON-ответа клиенту

## Особенности реализации

### Аутентификация
- Используется кастомная JWT-аутентификация на основе `djangorestframework_simplejwt`.
- Настройки JWT:
  - `ACCESS_TOKEN_LIFETIME`: 2 часа
  - `REFRESH_TOKEN_LIFETIME`: 14 дней
  - `ROTATE_REFRESH_TOKENS`: False (refresh-токены не обновляются при использовании)
  - `BLACKLIST_AFTER_ROTATION`: True (старые токены заносятся в чёрный список после ротации)
  - Алгоритм: HS256 (симметричное шифрование с использованием `SECRET_KEY`)
- Пользовательская модель: `User` (с полями `email` и `password`).
- Процесс авторизации:
  1. Клиент отправляет запрос с заголовком `Authorization: Bearer <token>`.
  2. Метод `get_token` извлекает токен из заголовка:
     - Проверяет наличие `Bearer` в заголовке.
     - Возвращает токен или `None`, если заголовок некорректен.
  3. Метод `get_user` валидирует токен и получает пользователя:
     - Использует `JwtSerializer` для проверки токена.
     - Если токен валиден, возвращает объект `User` из базы.
     - Обновляет поле `access_at` у пользователя (время последнего доступа).
     - Если токен невалиден, вызывает `AuthenticationError`.
- Поддерживаемые операции:
  - Регистрация пользователя (`register_user`).
  - Логин (`login_user`) с генерацией access и refresh токенов.
  - Обновление токена (`token_refresh`).
  - Удаление пользователя (`delete_user`).
  - Смена пароля (`change_password`).